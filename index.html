<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neuropathy Monitor — Demo</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --primary:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --border:#e2e8f0; --shadow:0 8px 24px rgba(15,23,42,.08);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--font); color:var(--text); background:var(--bg);}
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(246,248,251,.9); backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1050px; margin:0 auto; padding:16px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700;}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background:linear-gradient(135deg, #60a5fa, #34d399);
      box-shadow:var(--shadow);
    }
    .pill{border:1px solid var(--border); background:var(--card); padding:8px 10px; border-radius:999px; display:flex; gap:8px; align-items:center;}
    .btn{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn.primary{background:var(--primary); color:#fff; border-color:transparent;}
    .btn.ghost{background:transparent;}
    .btn:active{transform:translateY(1px)}
    .seg{display:flex; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--card);}
    .seg button{border:0; background:transparent; padding:10px 12px; cursor:pointer; font-weight:700; color:var(--muted);}
    .seg button.active{background:rgba(37,99,235,.12); color:var(--primary);}
    .grid{display:grid; gap:14px; grid-template-columns: 1.1fr .9fr;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    h1{font-size:22px; margin:0 0 8px;}
    h2{font-size:16px; margin:0 0 10px;}
    p{margin:8px 0; color:var(--muted); line-height:1.45;}
    .muted{color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; font-weight:800; font-size:12px;}
    .badge.ok{background:rgba(22,163,74,.12); color:var(--ok);}
    .badge.warn{background:rgba(245,158,11,.14); color:var(--warn);}
    .badge.bad{background:rgba(239,68,68,.14); color:var(--bad);}
    .kpi{display:flex; gap:10px; flex-wrap:wrap;}
    .kpi .mini{flex:1; min-width:160px; border:1px solid var(--border); border-radius:16px; padding:12px; background:linear-gradient(180deg, #fff, #fbfdff);}
    .mini .v{font-size:18px; font-weight:900;}
    .mini .l{font-size:12px; color:var(--muted); margin-top:2px;}
    .divider{height:1px; background:var(--border); margin:12px 0;}
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{border:1px solid var(--border); border-radius:16px; padding:12px; display:flex; justify-content:space-between; gap:10px; background:#fff;}
    .item .left{display:flex; flex-direction:column; gap:4px;}
    .item .title{font-weight:800;}
    .item .sub{color:var(--muted); font-size:12px;}
    .chip{font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .chip.ok{border-color:rgba(22,163,74,.25); color:var(--ok);}
    .chip.warn{border-color:rgba(245,158,11,.35); color:var(--warn);}
    .chip.bad{border-color:rgba(239,68,68,.35); color:var(--bad);}
    .chip.gray{color:var(--muted);}

    .form{display:flex; flex-direction:column; gap:12px;}
    .field{border:1px solid var(--border); border-radius:16px; padding:12px;}
    .field label{font-weight:800; font-size:13px;}
    .field .hint{font-size:12px; color:var(--muted); margin-top:4px;}
    .sliderRow{display:flex; align-items:center; gap:10px; margin-top:10px;}
    input[type="range"]{width:100%;}
    .val{min-width:44px; text-align:right; font-weight:900;}
    .choices{display:grid; gap:10px; grid-template-columns:1fr;}
    .choice{
      border:1px solid var(--border); border-radius:16px; padding:12px; cursor:pointer; background:#fff;
      display:flex; justify-content:space-between; gap:12px;
    }
    .choice.selected{border-color:rgba(37,99,235,.35); background:rgba(37,99,235,.06);}
    .choice .cTitle{font-weight:900;}
    .choice .cSub{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35;}
    .stepper{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--border);}
    .dot.on{background:var(--primary);}
    .row2{display:flex; gap:10px; flex-wrap:wrap;}
    .row2 .btn{flex:1; min-width:140px;}
    .toast{
      position:fixed; right:14px; bottom:14px; max-width:360px;
      background:#0b1220; color:#fff; border-radius:16px; padding:12px 14px; box-shadow:var(--shadow);
      display:none;
    }
    canvas{width:100%; height:220px; border-radius:16px; border:1px solid var(--border); background:#fff;}
    .small{font-size:12px;}
    .langNote{font-size:12px; color:var(--muted);}

    .footerNote{
      margin-top:14px; font-size:12px; color:var(--muted); line-height:1.4;
      border-left:3px solid rgba(37,99,235,.3); padding-left:10px;
    }
    a{color:var(--primary); text-decoration:none;}
    a:hover{text-decoration:underline;}
  
    .shortcuts{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:10px; box-shadow:var(--shadow); margin:12px 0 14px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .shortcuts .left{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .shortcuts .label{font-weight:900; font-size:12px; color:var(--muted);}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px;}

  </style>
</head>
<body>

<script>
/* Demo boot diagnostics */
(function(){
  function setBoot(msg){
    var el=document.getElementById('app');
    if(el){ el.innerHTML = '<div class="card"><div class="h2">Loading…</div><div class="small muted">'+msg+'</div></div>'; }
  }
  window.__demoBoot = { started: Date.now() };
  window.addEventListener('error', function(e){
    var el=document.getElementById('app');
    if(el){
      el.innerHTML = '<div class="card"><div class="h2">Demo script error</div>'
        +'<div class="small muted">Your browser blocked or errored while running the demo JavaScript.</div>'
        +'<div class="small" style="margin-top:10px;white-space:pre-wrap;">'+(e.message||e.error||'')+'</div>'
        +'<div class="small muted" style="margin-top:10px;">Try: Incognito window (disable extensions), or another browser.</div>'
        +'</div>';
    }
  });
  document.addEventListener('DOMContentLoaded', function(){ setBoot('Initializing…'); });
})();
</script>

  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div style="font-size:14px">Neuropathy Monitor</div>
            <div class="langNote" id="subtitle">Patient Demo • Bilingual (EN/繁中)</div>
          </div>
        </div>

        <div class="row" style="gap:10px">
          <div class="seg" aria-label="mode switch">
            <button id="modePatient" class="active" onclick="setMode('patient')">Patient App</button>
            <button id="modeCare" onclick="setMode('care')">Care Web</button>
          </div>
          <div class="seg" aria-label="language switch">
            <button id="langEN" class="active" onclick="setLang('en')">EN</button>
            <button id="langZH" onclick="setLang('zh')">繁中</button>
          </div>
          <button class="btn" onclick="resetDemo()">
            <span id="resetLabel">Reset demo</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app"></div>

  <div class="toast" id="toast"></div>

<script>
/* -------------------------
   Simple bilingual strings
-------------------------- */
const T = {
  en: {
    subtitle: "Patient Demo • Bilingual (EN/繁中)",
    reset: "Reset demo",
    consentTitle: "Welcome",
    consentBody: "Neuropathy Monitor helps you track numbness/tingling/pain and how it affects daily life during EV or chemotherapy.",
    consentSafety: "This is NOT an emergency service and does NOT provide diagnosis or treatment decisions. If you have severe symptoms or urgent concerns, contact your care team or local emergency services.",
    consentAgree: "I understand & continue",
    homeTitle: "Home",
    due: "Weekly check-in is due",
    notDue: "Next check-in",
    startCheckin: "Start check-in",
    quickStatus: "Your current status",
    lastUpdated: "Last updated",
    green: "Green",
    yellow: "Yellow",
    red: "Red",
    suggestion: "Suggestion",
    suggGreen: "Keep tracking weekly. Continue safety tips and foot care.",
    suggYellow: "Monitor closely. Consider contacting your care team if symptoms persist or worsen.",
    suggRed: "Please contact your care team within 24–48 hours for assessment.",
    tipsTitle: "Self-care tips",
    tips: [
      "Use night-lights and keep walkways clear to reduce fall risk.",
      "Wear well-fitted footwear and inspect feet daily.",
      "Avoid very hot/cold surfaces; check bath water temperature."
    ],
    goTrends: "View trends",
    goSummary: "Visit summary",
    checkinTitle: "Weekly Check-in",
    step: "Step",
    step1: "PNQ — Sensory",
    step2: "PNQ — Motor",
    step3: "Quick scale",
    step4: "Safety",
    step5: "Review",
    pnqPromptSensory: "Which statement best matches your sensory symptoms (numbness/tingling/pain)?",
    pnqPromptMotor: "Which statement best matches your motor / movement symptoms?",
    pnqA: "A. None",
    pnqB: "B. Mild, does not affect daily life",
    pnqC: "C. Moderate, affects some activities",
    pnqD: "D. Significant, affects daily function",
    pnqE: "E. Severe, cannot do normal activities",
    pnqSensorySub: [
      "No numbness/tingling/pain.",
      "Mild symptoms, you can do usual activities.",
      "Symptoms make some activities harder (e.g., using chopsticks, walking longer).",
      "Symptoms clearly limit daily tasks.",
      "Severe limitation; you cannot do normal tasks."
    ],
    pnqMotorSub: [
      "No weakness or movement difficulty.",
      "Slight clumsiness; still able to function normally.",
      "Noticeable difficulty with fine motor or walking; some activity limitation.",
      "Major difficulty with walking or hand function; needs help or adaptation.",
      "Severe disability due to motor symptoms."
    ],
    slidersTitle: "Quick symptom scale (0–10)",
    numb: "Numbness",
    ting: "Tingling",
    pain: "Pain",
    interfere: "Daily life impact",
    interfereHint: "How much symptoms affect walking, balance, using hands, sleep, etc.",
    safetyTitle: "Safety check",
    fallQ: "Did you fall or almost fall this week?",
    sleepQ: "Sleep impact (0–10)",
    yes: "Yes",
    no: "No",
    back: "Back",
    next: "Next",
    submit: "Submit",
    reviewTitle: "Review your answers",
    resultTitle: "Your result",
    why: "Why this level",
    contact: "Contact your care team",
    office: "Office hours",
    contactHint: "This demo uses placeholder contact info.",
    trendsTitle: "Trends (last 8 weeks)",
    legend: "Scores: numbness/tingling/pain/impact",
    summaryTitle: "Visit summary",
    summaryNote: "Show this summary to your doctor or nurse at the next visit.",
    export: "Copy summary text",
    copied: "Copied",
    careTitle: "Care Dashboard (Demo)",
    careSub: "A simple web view for nurses/physicians to monitor weekly reports.",
    patients: "Patients",
    alerts: "Alerts",
    overdue: "Overdue",
    worsening: "Worsening",
    view: "View",
    patientDetail: "Patient detail",
    lastCheckin: "Last check-in",
    rag: "Risk level",
    pnq: "PNQ",
    notes: "Notes",
    demoFoot: "Demo only. Replace thresholds, contact info, and consent text with your institution’s approved version."
  },
  zh: {
    subtitle: "病人版 Demo • 中英雙語（EN/繁中）",
    reset: "重置 Demo",
    consentTitle: "歡迎使用",
    consentBody: "Neuropathy Monitor 協助您在接受 EV 或一般化療期間，追蹤麻木／刺痛／疼痛與日常功能影響。",
    consentSafety: "本工具非急救服務，也不提供診斷或治療決策。若症狀嚴重或有緊急疑慮，請聯絡醫療團隊或撥打當地緊急電話。",
    consentAgree: "我了解並繼續",
    homeTitle: "首頁",
    due: "本週回報到期",
    notDue: "下次回報",
    startCheckin: "開始回報",
    quickStatus: "目前狀態",
    lastUpdated: "更新時間",
    green: "綠",
    yellow: "黃",
    red: "紅",
    suggestion: "建議",
    suggGreen: "維持每週追蹤，持續安全與足部照護。",
    suggYellow: "請密切觀察；若持續或惡化，建議與醫療團隊聯絡。",
    suggRed: "建議於 24–48 小時內聯絡醫療團隊評估。",
    tipsTitle: "自我照護小提醒",
    tips: [
      "夜間使用小夜燈、保持走道清空以降低跌倒風險。",
      "穿合腳鞋襪並每日檢查足部皮膚。",
      "避免過冷/過熱接觸，洗澡前先測水溫。"
    ],
    goTrends: "查看趨勢",
    goSummary: "門診摘要",
    checkinTitle: "每週回報",
    step: "步驟",
    step1: "PNQ—感覺",
    step2: "PNQ—動作",
    step3: "快速量表",
    step4: "安全檢查",
    step5: "確認送出",
    pnqPromptSensory: "下列哪一句最符合您本週的感覺症狀（麻木/刺痛/疼痛）？",
    pnqPromptMotor: "下列哪一句最符合您本週的動作/行走症狀？",
    pnqA: "A. 無",
    pnqB: "B. 輕微，不影響生活",
    pnqC: "C. 中等，影響部分活動",
    pnqD: "D. 明顯，影響日常功能",
    pnqE: "E. 嚴重，無法正常活動",
    pnqSensorySub: [
      "沒有麻木／刺痛／疼痛。",
      "症狀輕微，仍可做平常活動。",
      "部分活動變得較困難（如拿筷子、走較久）。",
      "症狀明顯限制日常工作。",
      "嚴重限制，無法完成平常活動。"
    ],
    pnqMotorSub: [
      "沒有無力或動作困難。",
      "稍微笨拙，但仍可正常活動。",
      "精細動作或走路變困難，部分活動受限。",
      "走路或手部功能明顯困難，需要協助或調整。",
      "動作症狀造成嚴重失能。"
    ],
    slidersTitle: "快速症狀量表（0–10）",
    numb: "麻木",
    ting: "刺痛",
    pain: "疼痛",
    interfere: "日常影響",
    interfereHint: "症狀對走路、平衡、手部使用、睡眠等影響程度",
    safetyTitle: "安全檢查",
    fallQ: "本週是否跌倒或差點跌倒？",
    sleepQ: "睡眠影響（0–10）",
    yes: "是",
    no: "否",
    back: "返回",
    next: "下一步",
    submit: "送出",
    reviewTitle: "確認您的回報",
    resultTitle: "回報結果",
    why: "判定原因",
    contact: "聯絡醫療團隊",
    office: "門診時間",
    contactHint: "此 Demo 使用示意聯絡資訊。",
    trendsTitle: "趨勢（近 8 週）",
    legend: "分數：麻木/刺痛/疼痛/影響",
    summaryTitle: "門診摘要",
    summaryNote: "回診時可將此摘要給醫師或護理師參考。",
    export: "複製摘要文字",
    copied: "已複製",
    careTitle: "照護端儀表板（Demo）",
    careSub: "提供護理師/醫師快速掌握每週回報與警示。",
    patients: "病人清單",
    alerts: "警示",
    overdue: "逾期未回報",
    worsening: "快速惡化",
    view: "查看",
    patientDetail: "病人明細",
    lastCheckin: "最近回報",
    rag: "風險分級",
    pnq: "PNQ",
    notes: "備註",
    demoFoot: "僅 Demo。實際上線請依院內核准版本調整門檻、聯絡資訊與同意書文字。"
  }
};

const STORE_KEY = "nm_demo_v1";

/* -------------------------
   Demo state
-------------------------- */
let state = loadState() || seedState();
let lang = state.lang || "en";
let mode = state.mode || "patient"; // patient | care
let route = state.route || "consent"; // consent | home | checkin | result | trends | summary | care
let checkinStep = state.checkinStep || 1;

function seedState(){
  const now = new Date();
  const weeks = [];
  // seed 7 past weeks scores
  let base = 2.0;
  for(let i=7;i>=1;i--){
    const d = new Date(now);
    d.setDate(now.getDate() - i*7);
    // mild upward trend
    base = Math.min(7, Math.max(0, base + (Math.random()*0.9 - 0.2)));
    weeks.push({
      date: d.toISOString(),
      numb: clamp(round(base + (Math.random()*1.2-0.6),1),0,10),
      ting: clamp(round(base + (Math.random()*1.2-0.6),1),0,10),
      pain: clamp(round(base + (Math.random()*1.2-0.6),1),0,10),
      impact: clamp(round(base + (Math.random()*1.2-0.6),1),0,10),
      pnqSensory: "B",
      pnqMotor: "A",
      fall: false,
      sleep: clamp(round(2 + Math.random()*2,1),0,10),
      rag: "green",
      reasons: ["stable"]
    });
  }
  const profile = { therapy: "EV + chemotherapy", nextDue: nextDueDate(now).toISOString() };
  const last = weeks[weeks.length-1];
  last.rag = computeRAG(last).rag;
  last.reasons = computeRAG(last).reasons;
  return {
    lang:"en", mode:"patient", route:"consent",
    profile,
    weeks,
    draft: { pnqSensory:null, pnqMotor:null, numb:2, ting:2, pain:2, impact:2, fall:false, sleep:2 },
    checkinStep:1,
    care: {
      contacts: { phone:"+886-2-0000-0000", line:"@careteam-demo", office:"Mon–Fri 09:00–17:00" },
      patients: [
        { id:"P-1027", name:"Patient A", therapy:"EV", rag:"yellow", last: weeks[weeks.length-1].date },
        { id:"P-2044", name:"Patient B", therapy:"Taxane", rag:"green", last: weeks[weeks.length-2].date },
        { id:"P-3091", name:"Patient C", therapy:"Platinum", rag:"red", last: weeks[weeks.length-3].date }
      ]
    }
  };
}

function saveState(){
  state.lang = lang; state.mode = mode; state.route = route; state.checkinStep = checkinStep;
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function resetDemo(){
  localStorage.removeItem(STORE_KEY);
  state = seedState();
  lang = "en"; mode="patient"; route="consent"; checkinStep=1;
  toast("Reset");
  render();
}
function setLang(l){
  lang = l; saveState(); render();
}
function setMode(m){
  mode = m;
  document.getElementById("modePatient").classList.toggle("active", m==="patient");
  document.getElementById("modeCare").classList.toggle("active", m==="care");
  route = (m==="care") ? "care" : (state.route && state.route!=="care" ? state.route : "home");
  saveState(); render();
}
function goto(r){
  route = r;
  if(mode==="care") route="care";
  saveState();
  render();
}

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function round(x,d){ const p=Math.pow(10,d); return Math.round(x*p)/p; }
function fmtDate(iso){
  const d = new Date(iso);
  const opt = { year:"numeric", month:"short", day:"2-digit" };
  return d.toLocaleDateString(lang==="zh" ? "zh-TW" : "en-US", opt);
}
function nextDueDate(now){
  const d = new Date(now);
  d.setDate(d.getDate()+7);
  return d;
}

/* -------------------------
   Risk engine (transparent rules)
-------------------------- */
function computeRAG(entry, prev){
  const reasons=[];
  const red = (
    entry.pain>=7 ||
    entry.numb>=8 ||
    entry.ting>=8 ||
    entry.impact>=6 ||
    entry.fall===true ||
    (prev && (
      (entry.pain - prev.pain)>=3 ||
      (entry.numb - prev.numb)>=3 ||
      (entry.ting - prev.ting)>=3 ||
      (entry.impact - prev.impact)>=3
    )) ||
    entry.pnqSensory==="D" || entry.pnqSensory==="E" ||
    entry.pnqMotor==="D" || entry.pnqMotor==="E"
  );
  const yellow = (
    entry.pain>=4 || entry.numb>=4 || entry.ting>=4 || entry.impact>=4 ||
    (prev && (
      (entry.pain - prev.pain)>=2 ||
      (entry.numb - prev.numb)>=2 ||
      (entry.ting - prev.ting)>=2 ||
      (entry.impact - prev.impact)>=2
    )) ||
    entry.pnqSensory==="C" || entry.pnqMotor==="C"
  );

  if(red){
    if(entry.pain>=7) reasons.push("pain ≥ 7");
    if(entry.numb>=8) reasons.push("numbness ≥ 8");
    if(entry.ting>=8) reasons.push("tingling ≥ 8");
    if(entry.impact>=6) reasons.push("impact ≥ 6");
    if(entry.fall) reasons.push("fall / near-fall");
    if(prev){
      if(entry.pain-prev.pain>=3) reasons.push("pain ↑ ≥ 3");
      if(entry.numb-prev.numb>=3) reasons.push("numbness ↑ ≥ 3");
      if(entry.ting-prev.ting>=3) reasons.push("tingling ↑ ≥ 3");
      if(entry.impact-prev.impact>=3) reasons.push("impact ↑ ≥ 3");
    }
    if(["D","E"].includes(entry.pnqSensory)) reasons.push("PNQ sensory D/E");
    if(["D","E"].includes(entry.pnqMotor)) reasons.push("PNQ motor D/E");
    return { rag:"red", reasons };
  }
  if(yellow){
    if(entry.pain>=4) reasons.push("pain ≥ 4");
    if(entry.numb>=4) reasons.push("numbness ≥ 4");
    if(entry.ting>=4) reasons.push("tingling ≥ 4");
    if(entry.impact>=4) reasons.push("impact ≥ 4");
    if(prev){
      if(entry.pain-prev.pain>=2) reasons.push("pain ↑ ≥ 2");
      if(entry.numb-prev.numb>=2) reasons.push("numbness ↑ ≥ 2");
      if(entry.ting-prev.ting>=2) reasons.push("tingling ↑ ≥ 2");
      if(entry.impact-prev.impact>=2) reasons.push("impact ↑ ≥ 2");
    }
    if(entry.pnqSensory==="C") reasons.push("PNQ sensory C");
    if(entry.pnqMotor==="C") reasons.push("PNQ motor C");
    return { rag:"yellow", reasons };
  }
  reasons.push("stable / mild");
  return { rag:"green", reasons };
}

function ragBadge(r){
  const t=T[lang];
  if(r==="green") return `<span class="badge ok">${t.green}</span>`;
  if(r==="yellow") return `<span class="badge warn">${t.yellow}</span>`;
  return `<span class="badge bad">${t.red}</span>`;
}
function ragLabel(r){
  const t=T[lang];
  if(r==="green") return t.green;
  if(r==="yellow") return t.yellow;
  return t.red;
}
function ragSuggestion(r){
  const t=T[lang];
  if(r==="green") return t.suggGreen;
  if(r==="yellow") return t.suggYellow;
  return t.suggRed;
}

/* -------------------------
   UI helpers
-------------------------- */
function toast(msg){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.style.display="block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer=setTimeout(()=>{el.style.display="none";}, 1600);
}

function headerActions(){
  const t=T[lang];
  document.getElementById("subtitle").textContent = t.subtitle;
  document.getElementById("resetLabel").textContent = t.reset;
  document.getElementById("langEN").classList.toggle("active", lang==="en");
  document.getElementById("langZH").classList.toggle("active", lang==="zh");
  document.getElementById("modePatient").classList.toggle("active", mode==="patient");
  document.getElementById("modeCare").classList.toggle("active", mode==="care");
}

/* -------------------------
   Screens
-------------------------- */
function screenConsent(){
  const t=T[lang];
  return `
  <div class="grid">
    <div class="card">
      <h1>${t.consentTitle}</h1>
      <p>${t.consentBody}</p>
      <div class="divider"></div>
      <p><b>${t.consentSafety}</b></p>
      <div class="row2" style="margin-top:12px">
        <button class="btn primary" onclick="agreeConsent()">${t.consentAgree}</button>
      </div>
      <div class="footerNote">${t.demoFoot}</div>
    </div>

    <div class="card">
      <h2>What you can click in this demo</h2>
      <p class="small">
        • Weekly check-in with PNQ (sensory + motor)<br/>
        • Green/Yellow/Red result + simple suggestions<br/>
        • Trends chart (local demo data)<br/>
        • Visit summary (copy text)<br/>
        • Care Web dashboard tab
      </p>
      <div class="divider"></div>
      <p class="small muted">
        Tip: Use the <b>EN/繁中</b> toggle on top.
      </p>
    </div>
  </div>`;
}
function agreeConsent(){
  route="home";
  saveState();
  render();
}

function screenHome(){
  const t=T[lang];
  const last = state.weeks[state.weeks.length-1];
  const now = new Date();
  const due = true; // demo: always due
  return `
  <div class="grid">
    <div class="card">
      <h1>${t.homeTitle}</h1>
      <div class="kpi" style="margin-top:10px">
        <div class="mini">
          <div class="v">${due ? "✅" : "⏳"} ${due ? t.due : t.notDue}</div>
          <div class="l">${fmtDate(new Date().toISOString())}</div>
        </div>
        <div class="mini">
          <div class="v">${ragBadge(last.rag)}</div>
          <div class="l">${t.lastUpdated}: ${fmtDate(last.date)}</div>
        </div>
      </div>

      <div class="divider"></div>
      <h2>${t.quickStatus}</h2>
      <p><b>${t.suggestion}:</b> ${ragSuggestion(last.rag)}</p>

      <div class="row2" style="margin-top:12px">
        <button class="btn primary" onclick="startCheckin()">${t.startCheckin}</button>
        <button class="btn" onclick="goto('trends')">${t.goTrends}</button>
        <button class="btn" onclick="goto('summary')">${t.goSummary}</button>
      </div>
    </div>

    <div class="card">
      <h2>${t.tipsTitle}</h2>
      <div class="list">
        ${t.tips.map(x=>`<div class="item"><div class="left"><div class="title">${x}</div></div><div class="chip gray">Tip</div></div>`).join("")}
      </div>
      <div class="divider"></div>
      <div class="small muted">Therapy: ${state.profile.therapy}</div>
    </div>
  </div>`;
}
function startCheckin(){
  checkinStep=1;
  state.draft = { pnqSensory:null, pnqMotor:null, numb:2, ting:2, pain:2, impact:2, fall:false, sleep:2 };
  route="checkin";
  saveState();
  render();
}

function stepDots(){
  const total=5;
  let dots="";
  for(let i=1;i<=total;i++){
    dots += `<div class="dot ${i<=checkinStep ? "on":""}"></div>`;
  }
  return `<div class="stepper">${dots}<span class="small muted">${T[lang].step} ${checkinStep}/5</span></div>`;
}

function pnqChoice(letter, title, sub, selected, onClick){
  return `
  <div class="choice ${selected ? "selected":""}" onclick="${onClick}">
    <div>
      <div class="cTitle">${title}</div>
      <div class="cSub">${sub}</div>
    </div>
    <div class="chip">${letter}</div>
  </div>`;
}

function screenCheckin(){
  const t=T[lang];
  const d=state.draft;
  const titleMap = {1:t.step1,2:t.step2,3:t.step3,4:t.step4,5:t.step5};
  return `
  <div class="grid">
    <div class="card">
      <div class="row" style="align-items:flex-start">
        <div>
          <h1>${t.checkinTitle}</h1>
          <p>${titleMap[checkinStep]}</p>
        </div>
        ${stepDots()}
      </div>
      <div class="divider"></div>
      ${checkinStep===1 ? stepPNQSensory() : ""}
      ${checkinStep===2 ? stepPNQMotor() : ""}
      ${checkinStep===3 ? stepSliders() : ""}
      ${checkinStep===4 ? stepSafety() : ""}
      ${checkinStep===5 ? stepReview() : ""}

      <div class="divider"></div>
      <div class="row2">
        <button class="btn" onclick="prevStep()">${t.back}</button>
        ${checkinStep<5
          ? `<button class="btn primary" onclick="nextStep()">${t.next}</button>`
          : `<button class="btn primary" onclick="submitCheckin()">${t.submit}</button>`
        }
      </div>
    </div>

    <div class="card">
      <h2>PNQ in this demo</h2>
      <p class="small muted">
        PNQ = Patient Neurotoxicity Questionnaire. Here we use a patient-friendly wording to keep the demo short.
      </p>
      <div class="divider"></div>
      <p class="small muted">
        Note: A real product should use your institution’s validated wording and approved translation.
      </p>
      <div class="footerNote">${t.demoFoot}</div>
    </div>
  </div>`;
}

function stepPNQSensory(){
  const t=T[lang];
  const d=state.draft;
  const letters=["A","B","C","D","E"];
  const titles=[t.pnqA,t.pnqB,t.pnqC,t.pnqD,t.pnqE];
  const subs=t.pnqSensorySub;
  return `
    <div class="field">
      <label>${t.pnqPromptSensory}</label>
      <div class="choices" style="margin-top:10px">
        ${letters.map((L,i)=>pnqChoice(L, titles[i], subs[i], d.pnqSensory===L, `setDraft('pnqSensory','${L}')`)).join("")}
      </div>
      <div class="hint">${d.pnqSensory? "Selected: "+d.pnqSensory : "Pick one option."}</div>
    </div>`;
}
function stepPNQMotor(){
  const t=T[lang];
  const d=state.draft;
  const letters=["A","B","C","D","E"];
  const titles=[t.pnqA,t.pnqB,t.pnqC,t.pnqD,t.pnqE];
  const subs=t.pnqMotorSub;
  return `
    <div class="field">
      <label>${t.pnqPromptMotor}</label>
      <div class="choices" style="margin-top:10px">
        ${letters.map((L,i)=>pnqChoice(L, titles[i], subs[i], d.pnqMotor===L, `setDraft('pnqMotor','${L}')`)).join("")}
      </div>
      <div class="hint">${d.pnqMotor? "Selected: "+d.pnqMotor : "Pick one option."}</div>
    </div>`;
}
function sliderField(key, label, hint){
  const d=state.draft;
  return `
    <div class="field">
      <label>${label}</label>
      ${hint ? `<div class="hint">${hint}</div>` : ""}
      <div class="sliderRow">
        <input type="range" min="0" max="10" step="1" value="${d[key]}" oninput="setDraft('${key}', parseInt(this.value,10))"/>
        <div class="val">${d[key]}</div>
      </div>
    </div>`;
}
function stepSliders(){
  const t=T[lang];
  return `
    <div class="form">
      <div class="field">
        <label>${t.slidersTitle}</label>
        <div class="hint">${t.legend}</div>
      </div>
      ${sliderField("numb", t.numb)}
      ${sliderField("ting", t.ting)}
      ${sliderField("pain", t.pain)}
      ${sliderField("impact", t.interfere, t.interfereHint)}
    </div>`;
}
function stepSafety(){
  const t=T[lang];
  const d=state.draft;
  return `
    <div class="form">
      <div class="field">
        <label>${t.safetyTitle}</label>
        <div class="hint">${t.contactHint}</div>
      </div>
      <div class="field">
        <label>${t.fallQ}</label>
        <div class="row2" style="margin-top:10px">
          <button class="btn ${d.fall? "primary":""}" onclick="setDraft('fall', true)">${t.yes}</button>
          <button class="btn ${!d.fall? "primary":""}" onclick="setDraft('fall', false)">${t.no}</button>
        </div>
      </div>
      ${sliderField("sleep", t.sleepQ)}
    </div>`;
}
function stepReview(){
  const t=T[lang];
  const d=state.draft;
  const preview = computeRAG({
    ...d,
    date: new Date().toISOString()
  }, state.weeks[state.weeks.length-1]);

  return `
    <div class="field">
      <label>${t.reviewTitle}</label>
      <div class="divider"></div>
      <div class="item">
        <div class="left">
          <div class="title">${t.pnq} — Sensory: ${d.pnqSensory || "-"}</div>
          <div class="sub">${t.pnq} — Motor: ${d.pnqMotor || "-"}</div>
        </div>
        ${ragBadge(preview.rag)}
      </div>

      <div class="divider"></div>
      <div class="kpi">
        <div class="mini"><div class="v">${d.numb}</div><div class="l">${t.numb}</div></div>
        <div class="mini"><div class="v">${d.ting}</div><div class="l">${t.ting}</div></div>
        <div class="mini"><div class="v">${d.pain}</div><div class="l">${t.pain}</div></div>
        <div class="mini"><div class="v">${d.impact}</div><div class="l">${t.interfere}</div></div>
      </div>

      <div class="divider"></div>
      <div class="small"><b>${t.why}:</b> ${preview.reasons.join(", ")}</div>
    </div>`;
}

function setDraft(key,val){
  state.draft[key]=val;
  saveState();
  render();
}

function nextStep(){
  // basic validation for PNQ steps
  if(checkinStep===1 && !state.draft.pnqSensory){ toast(lang==="zh" ? "請先選 PNQ 感覺選項" : "Please select PNQ sensory option"); return; }
  if(checkinStep===2 && !state.draft.pnqMotor){ toast(lang==="zh" ? "請先選 PNQ 動作選項" : "Please select PNQ motor option"); return; }
  checkinStep = Math.min(5, checkinStep+1);
  saveState(); render();
}
function prevStep(){
  if(checkinStep===1){ goto("home"); return; }
  checkinStep = Math.max(1, checkinStep-1);
  saveState(); render();
}

function submitCheckin(){
  const d=state.draft;
  const prev=state.weeks[state.weeks.length-1];
  const entry = {
    date: new Date().toISOString(),
    numb: d.numb, ting: d.ting, pain: d.pain, impact: d.impact,
    pnqSensory: d.pnqSensory, pnqMotor: d.pnqMotor,
    fall: d.fall, sleep: d.sleep
  };
  const out = computeRAG(entry, prev);
  entry.rag = out.rag;
  entry.reasons = out.reasons;

  state.weeks.push(entry);
  // keep last 8
  if(state.weeks.length>8) state.weeks = state.weeks.slice(state.weeks.length-8);

  route="result";
  saveState();
  render();
}

function screenResult(){
  const t=T[lang];
  const last = state.weeks[state.weeks.length-1];
  const c = state.care.contacts;
  return `
  <div class="grid">
    <div class="card">
      <h1>${t.resultTitle}</h1>
      <div style="margin-top:8px">${ragBadge(last.rag)}</div>
      <p style="margin-top:10px"><b>${t.suggestion}:</b> ${ragSuggestion(last.rag)}</p>
      <div class="divider"></div>
      <div class="small"><b>${t.why}:</b> ${last.reasons.join(", ")}</div>

      <div class="divider"></div>
      <div class="row2">
        <button class="btn primary" onclick="goto('home')">${t.homeTitle}</button>
        <button class="btn" onclick="goto('trends')">${t.goTrends}</button>
        <button class="btn" onclick="goto('summary')">${t.goSummary}</button>
      </div>
    </div>

    <div class="card">
      <h2>${t.contact}</h2>
      <div class="list">
        <div class="item">
          <div class="left">
            <div class="title">Phone</div>
            <div class="sub">${c.phone}</div>
          </div>
          <div class="chip">Call</div>
        </div>
        <div class="item">
          <div class="left">
            <div class="title">LINE</div>
            <div class="sub">${c.line}</div>
          </div>
          <div class="chip">Chat</div>
        </div>
        <div class="item">
          <div class="left">
            <div class="title">${t.office}</div>
            <div class="sub">${c.office}</div>
          </div>
          <div class="chip gray">Info</div>
        </div>
      </div>
      <div class="footerNote">${t.consentSafety}</div>
    </div>
  </div>`;
}

function drawTrends(){
  const canvas=document.getElementById("trendCanvas");
  if(!canvas) return;
  const ctx=canvas.getContext("2d");
  // set real pixels
  const w=canvas.clientWidth, h=canvas.clientHeight;
  canvas.width = Math.floor(w*devicePixelRatio);
  canvas.height = Math.floor(h*devicePixelRatio);
  ctx.scale(devicePixelRatio, devicePixelRatio);

  const pad=18;
  const plotW = w - pad*2;
  const plotH = h - pad*2 - 18;
  // background
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle="#fff";
  roundRect(ctx,0,0,w,h,16,true,false);

  // axes
  ctx.strokeStyle="#e2e8f0";
  ctx.lineWidth=1;
  for(let i=0;i<=5;i++){
    const y = pad + (plotH*(i/5));
    ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad+plotW, y); ctx.stroke();
  }

  // labels 0..10
  ctx.fillStyle="#64748b";
  ctx.font="12px ui-sans-serif, system-ui";
  ctx.fillText("10", 6, pad+4);
  ctx.fillText("0", 10, pad+plotH+4);

  const data = state.weeks;
  const keys=["numb","ting","pain","impact"];
  const colors=["#2563eb","#16a34a","#ef4444","#f59e0b"]; // internal; ok for demo
  keys.forEach((k,idx)=>{
    ctx.strokeStyle=colors[idx];
    ctx.lineWidth=2;
    ctx.beginPath();
    data.forEach((d,i)=>{
      const x = pad + (plotW*(i/(data.length-1 || 1)));
      const y = pad + (plotH*(1 - (d[k]/10)));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  });

  // legend
  const t=T[lang];
  ctx.fillStyle="#0f172a";
  ctx.font="12px ui-sans-serif, system-ui";
  ctx.fillText(t.legend, pad, h-8);
}

function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  if (typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
  ctx.beginPath();
  ctx.moveTo(x+r.tl, y);
  ctx.lineTo(x+w-r.tr, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r.tr);
  ctx.lineTo(x+w, y+h-r.br);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r.br, y+h);
  ctx.lineTo(x+r.bl, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r.bl);
  ctx.lineTo(x, y+r.tl);
  ctx.quadraticCurveTo(x, y, x+r.tl, y);
  ctx.closePath();
  if(fill){ ctx.fill(); }
  if(stroke){ ctx.stroke(); }
}

function screenTrends(){
  const t=T[lang];
  return `
  <div class="grid">
    <div class="card">
      <h1>${t.trendsTitle}</h1>
      <p>${t.legend}</p>
      <canvas id="trendCanvas"></canvas>
      <div class="divider"></div>
      <div class="row2">
        <button class="btn" onclick="goto('home')">${t.homeTitle}</button>
        <button class="btn" onclick="goto('summary')">${t.goSummary}</button>
      </div>
    </div>

    <div class="card">
      <h2>Recent entries</h2>
      <div class="list">
        ${state.weeks.slice().reverse().slice(0,4).map(w=>`
          <div class="item">
            <div class="left">
              <div class="title">${fmtDate(w.date)} • ${ragLabel(w.rag)}</div>
              <div class="sub">PNQ S:${w.pnqSensory || "-"} / M:${w.pnqMotor || "-"} • N:${w.numb} T:${w.ting} P:${w.pain} I:${w.impact}</div>
            </div>
            <div class="chip ${w.rag==='green'?'ok':w.rag==='yellow'?'warn':'bad'}">${ragLabel(w.rag)}</div>
          </div>`).join("")}
      </div>
      <div class="footerNote">${t.demoFoot}</div>
    </div>
  </div>`;
}

function buildSummaryText(){
  const t=T[lang];
  const last = state.weeks[state.weeks.length-1];
  const prev = state.weeks.length>1 ? state.weeks[state.weeks.length-2] : null;
  const delta = prev ? {
    numb: last.numb-prev.numb, ting:last.ting-prev.ting, pain:last.pain-prev.pain, impact:last.impact-prev.impact
  } : null;

  const lines = [];
  lines.push(`Neuropathy Monitor — Visit Summary`);
  lines.push(`Date: ${fmtDate(last.date)}`);
  lines.push(`Therapy: ${state.profile.therapy}`);
  lines.push(`Risk level: ${ragLabel(last.rag)}`);
  lines.push(`PNQ: Sensory ${last.pnqSensory || "-"}, Motor ${last.pnqMotor || "-"}`);
  lines.push(`Scores (0–10): Numbness ${last.numb}, Tingling ${last.ting}, Pain ${last.pain}, Impact ${last.impact}`);
  if(delta){
    lines.push(`Change vs last week: N ${fmtSigned(delta.numb)} / T ${fmtSigned(delta.ting)} / P ${fmtSigned(delta.pain)} / I ${fmtSigned(delta.impact)}`);
  }
  lines.push(`Fall/near-fall: ${last.fall ? "Yes" : "No"}; Sleep impact: ${last.sleep}`);
  lines.push(`Reasons: ${last.reasons.join(", ")}`);
  lines.push(`Note: This is a monitoring tool; clinical assessment is required for medical decisions.`);
  return lines.join("\n");
}
function fmtSigned(x){
  const n = Math.round(x*10)/10;
  return (n>0? "+"+n : ""+n);
}

function screenSummary(){
  const t=T[lang];
  const text = buildSummaryText();
  const last = state.weeks[state.weeks.length-1];
  return `
  <div class="grid">
    <div class="card">
      <h1>${t.summaryTitle}</h1>
      <p>${t.summaryNote}</p>
      <div class="divider"></div>
      <div class="field">
        <label>${t.summaryTitle}</label>
        <div class="hint">Text preview (demo)</div>
        <pre style="white-space:pre-wrap; margin:10px 0 0; font-size:12px; color:#0f172a;">${escapeHtml(text)}</pre>
      </div>
      <div class="row2">
        <button class="btn primary" onclick="copySummary()">${t.export}</button>
        <button class="btn" onclick="goto('home')">${t.homeTitle}</button>
        <button class="btn" onclick="goto('trends')">${t.goTrends}</button>
      </div>
    </div>

    <div class="card">
      <h2>${t.resultTitle}</h2>
      <div style="margin-top:8px">${ragBadge(last.rag)}</div>
      <p><b>${t.suggestion}:</b> ${ragSuggestion(last.rag)}</p>
      <div class="footerNote">${t.demoFoot}</div>
    </div>
  </div>`;
}
function escapeHtml(str){
  return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function copySummary(){
  const t=T[lang];
  const text=buildSummaryText();
  navigator.clipboard.writeText(text).then(()=>{
    toast(t.copied);
  }).catch(()=>toast("Copy failed"));
}

/* -------------------------
   Care Dashboard
-------------------------- */
function screenCare(){
  const t=T[lang];
  const patients = state.care.patients;
  return `
  <div class="grid">
    <div class="card">
      <h1>${t.careTitle}</h1>
      <p>${t.careSub}</p>
      <div class="divider"></div>
      <h2>${t.patients}</h2>
      <div class="list">
        ${patients.map(p=>`
          <div class="item">
            <div class="left">
              <div class="title">${p.id} • ${p.name}</div>
              <div class="sub">${p.therapy} • ${t.lastCheckin}: ${fmtDate(p.last)}</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
              <div class="chip ${p.rag==='green'?'ok':p.rag==='yellow'?'warn':'bad'}">${ragLabel(p.rag)}</div>
              <button class="btn" onclick="openPatient('${p.id}')">${t.view}</button>
            </div>
          </div>`).join("")}
      </div>
    </div>

    <div class="card" id="careDetail">
      ${careDetail(null)}
      <div class="footerNote">${t.demoFoot}</div>
    </div>
  </div>`;
}

function openPatient(id){
  const el=document.getElementById("careDetail");
  if(!el) return;
  el.innerHTML = careDetail(id) + `<div class="footerNote">${T[lang].demoFoot}</div>`;
  // also show trends based on main patient data
  setTimeout(drawTrends, 30);
}

function careDetail(id){
  const t=T[lang];
  if(!id){
    return `<h2>${t.patientDetail}</h2><p class="muted small">Select a patient from the list to view details.</p>`;
  }
  // For demo, reuse same trend data
  const last = state.weeks[state.weeks.length-1];
  return `
    <h2>${t.patientDetail}: ${id}</h2>
    <div class="kpi" style="margin-top:10px">
      <div class="mini"><div class="v">${ragBadge(last.rag)}</div><div class="l">${t.rag}</div></div>
      <div class="mini"><div class="v">S:${last.pnqSensory} / M:${last.pnqMotor}</div><div class="l">${t.pnq}</div></div>
    </div>
    <div class="divider"></div>
    <p class="small"><b>${t.lastCheckin}:</b> ${fmtDate(last.date)}</p>
    <p class="small"><b>${t.notes}:</b> ${last.reasons.join(", ")}</p>
    <div class="divider"></div>
    <canvas id="trendCanvas"></canvas>
  `;
}


function shortcutsBar(){
  if(mode!=="patient") return "";
  return `
    <div class="shortcuts">
      <div class="left">
        <div class="label">Demo shortcuts / 快速導覽</div>
        <button class="btn small" onclick="goto('consent')">1 Consent</button>
        <button class="btn small" onclick="goto('home')">2 Home</button>
        <button class="btn small" onclick="startCheckin()">3 Check-in</button>
        <button class="btn small" onclick="goto('result')">4 Result</button>
        <button class="btn small" onclick="goto('trends')">5 Trends</button>
        <button class="btn small" onclick="goto('summary')">6 Summary</button>
      </div>
      <div class="small muted">Tip: Home → “Start check-in” to see the full flow.</div>
    </div>
  `;
}


/* -------------------------
   Router
-------------------------- */
function render(){
  headerActions();
  const t=T[lang];
  const app=document.getElementById("app");
  if(mode==="care"){
    app.innerHTML = screenCare();
    setTimeout(drawTrends, 30);
    return;
  }
  if(route==="consent") app.innerHTML = shortcutsBar() + screenConsent()
  else if(route==="home") app.innerHTML = shortcutsBar() + screenHome()
  else if(route==="checkin") app.innerHTML = shortcutsBar() + screenCheckin()
  else if(route==="result") app.innerHTML = shortcutsBar() + screenResult()
  else if(route==="trends") { app.innerHTML = shortcutsBar() + screenTrends() setTimeout(drawTrends, 30); }
  else if(route==="summary") app.innerHTML = shortcutsBar() + screenSummary()
  else app.innerHTML = shortcutsBar() + screenHome()
}

document.addEventListener('DOMContentLoaded', function(){ try{ render(); }catch(e){ throw e; } });
</script>
</body>
</html>
